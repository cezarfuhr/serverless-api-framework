name: Deploy

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      stage:
        description: 'Deployment stage'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - staging
          - prod

jobs:
  deploy:
    name: Deploy to AWS
    runs-on: ubuntu-latest
    environment:
      name: ${{ github.event.inputs.stage || 'dev' }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ vars.AWS_REGION || 'us-east-1' }}

      - name: Install dependencies
        run: |
          npm ci
          cd backend && npm ci

      - name: Run tests
        run: cd backend && npm test

      - name: Deploy to AWS
        run: cd backend && npm run deploy -- --stage ${{ github.event.inputs.stage || 'dev' }}
        env:
          SES_FROM_EMAIL: ${{ secrets.SES_FROM_EMAIL }}

      - name: Get deployment outputs
        id: outputs
        run: |
          cd backend
          API_URL=$(serverless info --stage ${{ github.event.inputs.stage || 'dev' }} | grep "endpoint:" | awk '{print $2}')
          echo "api_url=$API_URL" >> $GITHUB_OUTPUT

      - name: Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `✅ Deployed successfully to **${{ github.event.inputs.stage || 'dev' }}**

              API URL: ${{ steps.outputs.outputs.api_url }}`
            })

      - name: Notify Slack on success
        if: success()
        uses: slackapi/slack-github-action@v1
        with:
          payload: |
            {
              "text": "✅ Deployment to ${{ github.event.inputs.stage || 'dev' }} succeeded",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "✅ *Deployment Successful*\n*Stage:* ${{ github.event.inputs.stage || 'dev' }}\n*Branch:* ${{ github.ref_name }}\n*Commit:* ${{ github.sha }}"
                  }
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        continue-on-error: true

      - name: Notify Slack on failure
        if: failure()
        uses: slackapi/slack-github-action@v1
        with:
          payload: |
            {
              "text": "❌ Deployment to ${{ github.event.inputs.stage || 'dev' }} failed",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "❌ *Deployment Failed*\n*Stage:* ${{ github.event.inputs.stage || 'dev' }}\n*Branch:* ${{ github.ref_name }}\n*Commit:* ${{ github.sha }}"
                  }
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        continue-on-error: true

  integration-tests:
    name: Integration Tests
    needs: deploy
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm ci

      - name: Run integration tests
        run: npm run test:integration
        env:
          API_URL: ${{ needs.deploy.outputs.api_url }}
        continue-on-error: true

  rollback:
    name: Rollback on Failure
    needs: [deploy, integration-tests]
    if: failure()
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ vars.AWS_REGION || 'us-east-1' }}

      - name: Install dependencies
        run: cd backend && npm ci

      - name: List deployments
        run: cd backend && serverless deploy list --stage ${{ github.event.inputs.stage || 'dev' }}

      - name: Notify about rollback requirement
        run: |
          echo "⚠️ Deployment failed. Manual rollback may be required."
          echo "Run: cd backend && serverless rollback --stage ${{ github.event.inputs.stage || 'dev' }} -t <timestamp>"
